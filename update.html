<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BITÁCORA ELECTRÓNICA PARA MONITOREO DE LOGÍSTICA</title>

    <!-- Tailwind CDN y librerías -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.7/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.7/plugin/customParseFormat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.7/plugin/utc.js"></script>
    <script>
      dayjs.extend(dayjs_plugin_customParseFormat);
      dayjs.extend(dayjs_plugin_utc);
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap"
      rel="stylesheet"
    />

    <style>
      body {
        font-family: "Inter", sans-serif;
        background-color: #f3f4f6;
      }
      .tab-btn {
        padding: 0.75rem 1.5rem;
        border-radius: 0.5rem 0.5rem 0 0;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
      }
      .tab-active {
        background-color: #ffffff;
        color: #1f2937;
        border-bottom: 3px solid #4f46e5;
      }
      .tab-content {
        background-color: #ffffff;
        padding: 1.5rem;
        border-radius: 0 0.5rem 0.5rem 0.5rem;
        min-height: 500px;
      }
      .incidencia-rojo {
        background-color: #fee2e2;
        color: #ef4444;
        border-left: 4px solid #ef4444;
      }
      .incidencia-naranja {
        background-color: #ffedd5;
        color: #f97316;
        border-left: 4px solid #f97316;
      }
      .incidencia-verde {
        background-color: #d1fae5;
        color: #10b981;
        border-left: 4px solid #10b981;
      }
      .estatus-verde {
        background-color: #d1fae5;
        color: #059669;
      }
      .estatus-rojo {
        background-color: #fee2e2;
        color: #dc2626;
      }
      .estatus-en-ruta {
        background-color: #fef3c7;
        color: #d97706;
      }
      .task-cell {
        background-color: #f9fafb;
        color: #4b5563;
      }
      .registro-board {
        display: grid;
        grid-template-columns: 1fr repeat(5, minmax(180px, 1fr));
        gap: 1px;
        border: 1px solid #e5e7eb;
        border-radius: 0.5rem;
        overflow: hidden;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }
      .board-row {
        display: contents;
      }
      .board-cell {
        padding: 1rem;
        background: #fff;
        border-right: 1px solid #e5e7eb;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
        font-size: 0.875rem;
      }
      .board-row:first-child .board-cell {
        background: #e5e7eb;
        font-weight: 600;
      }
      @media (max-width: 1024px) {
        .registro-board {
          grid-template-columns: 1fr;
        }
        .board-row {
          display: block;
          margin-bottom: 1rem;
          border: 1px solid #e5e7eb;
          border-radius: 0.5rem;
          overflow: hidden;
        }
        .board-row:first-child {
          display: none;
        }
        .board-cell {
          border-right: none;
          border-bottom: 1px solid #e5e7eb;
          align-items: flex-start;
          text-align: left;
          padding: 0.75rem 1rem;
        }
        .board-cell::before {
          content: attr(data-label);
          font-weight: 700;
          margin-right: 0.5rem;
          display: block;
          color: #4b5563;
          font-size: 0.75rem;
        }
        .board-row .unit-cell {
          background-color: #e5e7eb !important;
        }
      }
      .kpi-filter-btn {
        padding: 0.5rem 1rem;
        border-radius: 999px;
        background: #e5e7eb;
        cursor: pointer;
      }
      .kpi-filter-btn-active {
        background: #4f46e5;
        color: white;
      }
      .modal {
        background-color: rgba(0, 0, 0, 0.4);
      }
      a.map-link {
        color: #2563eb;
        text-decoration: underline;
      }
    </style>
  </head>

  <body>
    <div class="container mx-auto p-4 md:p-8">
      <!-- Header -->
      <header class="mb-6 bg-white p-6 rounded-xl shadow-md text-center">
        <img
          src="https://i.postimg.cc/CY2DgtbK/A-COLOR.png"
          alt="Logo"
          class="h-16 mx-auto mb-4"
        />
        <h1 class="text-3xl font-extrabold text-gray-900">
          BITÁCORA ELECTRÓNICA PARA MONITOREO DE LOGÍSTICA
        </h1>
        <p class="text-sm text-gray-500 mt-1">
          Centro de Monitoreo GEO-24 de TRACKER MEXICO GPS
        </p>
        <p>Desarrollo realizado por el Departamento de IA 2025</p>
      </header>

      <!-- Controles -->
      <div
        class="flex items-center justify-between bg-white p-4 rounded-xl shadow-md mb-6"
      >
        <div class="flex items-center space-x-3">
          <label for="date-filter" class="font-medium text-gray-700"
            >Fecha de Despacho:</label
          >
          <input
            type="date"
            id="date-filter"
            onchange="filterByDate()"
            class="p-2 border rounded-lg"
          />
        </div>
        <div class="flex space-x-3">
          <button
            onclick="exportUpdatedSheet()"
            class="bg-green-600 text-white px-4 py-2 rounded-lg"
          >
            Exportar XLSX
          </button>
        </div>
      </div>

      <!-- Tabs -->
      <div class="flex border-b border-gray-300 overflow-x-auto">
        <button class="tab-btn tab-active" onclick="changeTab(0)">
          01. Datos Generales
        </button>
        <button class="tab-btn text-gray-500" onclick="changeTab(1)">
          02. Rutas & Origen/Destino
        </button>
        <button class="tab-btn text-gray-500" onclick="changeTab(2)">
          03. Seguimiento Detallado
        </button>
        <button class="tab-btn text-gray-500" onclick="changeTab(3)">
          04. Matriz de Registro
        </button>
        <button class="tab-btn text-gray-500" onclick="changeTab(4)">
          05. KPIs de Cumplimiento
        </button>
        <button class="tab-btn text-gray-500" onclick="changeTab(5)">
          06. Informe Ejecutivo
        </button>
        <button class="tab-btn text-gray-500" onclick="changeTab(6)">
          07. Informes Guardados
        </button>
      </div>

      <!-- Tab contents -->
      <div class="tab-content shadow-lg">
        <!-- TAB 0 -->
        <div id="tab-0" class="tab-content-item">
          <h2 class="text-2xl font-semibold mb-4 text-gray-800">
            Datos Generales de Despachos
          </h2>
          <div
            id="datos-generales-container"
            class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"
          ></div>
        </div>

        <!-- TAB 1 -->
        <div id="tab-1" class="tab-content-item hidden">
          <h2 class="text-2xl font-semibold mb-4 text-gray-800">
            Origen y Destino de Unidades
          </h2>
          <div
            id="origen-destino-container"
            class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"
          ></div>
        </div>

        <!-- TAB 2: Seguimiento Detallado -->
        <div id="tab-2" class="tab-content-item hidden">
          <h2 class="text-2xl font-semibold mb-4 text-gray-800">
            Seguimiento y Registro de Tiempos
          </h2>

          <div
            class="flex flex-wrap items-center space-y-3 sm:space-y-0 sm:space-x-4 mb-6 p-4 border rounded-lg bg-gray-50"
          >
            <select
              id="unidad-selector"
              class="p-2 border rounded-lg flex-grow max-w-sm"
              onchange="handleUnidadSelection(event)"
            ></select>
            <button
              id="consulta-btn"
              onclick="showUnitData()"
              disabled
              class="bg-blue-600 text-white px-4 py-2 rounded-lg disabled:bg-blue-300"
            >
              Consultar Datos de Unidad
            </button>
          </div>

          <div
            id="seguimiento-form-container"
            class="hidden bg-white p-6 rounded-xl border"
          ></div>
        </div>

        <!-- TAB 3: Matriz -->
        <div id="tab-3" class="tab-content-item hidden">
          <h2 class="text-2xl font-semibold mb-4 text-gray-800">
            Matriz de Tiempos Programados vs. Reales
          </h2>
          <div class="mb-4">
            <label
              for="registro-unidad-filter"
              class="font-medium text-gray-700"
              >Filtrar por Unidad:</label
            >
            <select
              id="registro-unidad-filter"
              onchange="renderRegistroDespacho()"
              class="p-2 border rounded-lg ml-2"
            ></select>
          </div>
          <div id="registro-board-container" class="overflow-x-auto pb-4"></div>
        </div>

        <!-- TAB 4: KPIs -->
        <div id="tab-4" class="tab-content-item hidden">
          <h2 class="text-2xl font-semibold mb-4 text-gray-800">
            Key Performance Indicators (KPIs)
          </h2>
          <div
            id="kpi-filter-buttons"
            class="mb-6 flex flex-wrap gap-2 border-b pb-4"
          >
            <button
              class="kpi-filter-btn"
              onclick="filterAndRenderKPIs('selectedDate', event)"
            >
              Fecha Seleccionada
            </button>
            <button
              class="kpi-filter-btn"
              onclick="filterAndRenderKPIs('today', event)"
            >
              Hoy
            </button>
            <button
              class="kpi-filter-btn"
              onclick="filterAndRenderKPIs('week', event)"
            >
              Últimos 7 Días
            </button>
            <button
              class="kpi-filter-btn"
              onclick="filterAndRenderKPIs('month', event)"
            >
              Últimos 30 Días
            </button>
          </div>

          <div class="grid grid-cols-2 lg:grid-cols-5 gap-6 mb-8">
            <div class="bg-gray-800 text-white p-5 rounded-xl shadow-xl">
              <p class="text-sm font-medium opacity-80">Total Despachos</p>
              <p id="kpi-total-despachos" class="text-3xl font-bold mt-1">0</p>
            </div>
            <div class="bg-green-600 text-white p-5 rounded-xl shadow-xl">
              <p class="text-sm font-medium opacity-80">A Tiempo</p>
              <p id="kpi-despachos-a-tiempo" class="text-3xl font-bold mt-1">
                0
              </p>
            </div>
            <div class="bg-red-600 text-white p-5 rounded-xl shadow-xl">
              <p class="text-sm font-medium opacity-80">Con Retraso</p>
              <p id="kpi-despachos-retraso" class="text-3xl font-bold mt-1">
                0
              </p>
            </div>
            <div class="bg-yellow-600 text-white p-5 rounded-xl shadow-xl">
              <p class="text-sm font-medium opacity-80">En Ruta</p>
              <p id="kpi-despachos-en-ruta" class="text-3xl font-bold mt-1">
                0
              </p>
            </div>
            <div class="bg-blue-600 text-white p-5 rounded-xl shadow-xl">
              <p class="text-sm font-medium opacity-80">Programados</p>
              <p id="kpi-despachos-programados" class="text-3xl font-bold mt-1">
                0
              </p>
            </div>
          </div>

          <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
            <div class="lg:col-span-3 bg-white p-6 rounded-xl shadow-md">
              <h3 class="font-semibold text-lg mb-4">Estado de Despachos</h3>
              <canvas id="kpi-cumplimiento-chart"></canvas>
            </div>
            <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-md">
              <h3 class="font-semibold text-lg mb-4">Incidencias</h3>
              <canvas id="kpi-incidencias-chart"></canvas>
            </div>
          </div>
        </div>

        <!-- TAB 5: Informe Ejecutivo -->
        <div id="tab-5" class="tab-content-item hidden">
          <h2 class="text-2xl font-semibold mb-4 text-gray-800">
            Generación de Informes Ejecutivos
          </h2>
          <div id="informe-container" class="overflow-x-auto">
            <p>Seleccione un rango de fechas para generar el informe.</p>
          </div>

          <div class="mt-8 text-right border-t pt-6 space-x-3">
            <button
              id="download-report-btn"
              onclick="downloadWordReport()"
              disabled
              class="bg-blue-600 text-white px-6 py-2 rounded-lg disabled:bg-gray-400"
            >
              Descargar Informe (DOC)
            </button>
            <button
              id="download-excel-report-btn"
              onclick="downloadReportAsExcel()"
              disabled
              class="bg-blue-600 text-white px-6 py-2 rounded-lg disabled:bg-gray-400"
            >
              Descargar Detalle (XLSX)
            </button>
            <button
              onclick="guardarInformeEnBD()"
              id="guardar-informe-btn"
              class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700"
            >
              Guardar Informe
            </button>
          </div>
        </div>

        <div id="tab-6" class="tab-content-item hidden">
          <h2 class="text-2xl font-semibold mb-4 text-gray-800">
            Informes Guardados en Base de Datos
          </h2>

          <div class="mb-6">
            <button
              onclick="cargarInformesGuardados()"
              class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700"
            >
              Actualizar Lista
            </button>
            <!-- <button
              onclick="exportarTodosInformes()"
              class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 ml-2"
            >
              Exportar Todos (CSV)
            </button> -->
          </div>

          <!-- Filtros de Informes Guardados -->
          <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-4">
            <div class="grid grid-cols-1 md:grid-cols-5 gap-3">
              <div class="md:col-span-2">
                <label
                  for="informes-filtro-texto"
                  class="block text-sm font-medium text-gray-700"
                  >Buscar</label
                >
                <input
                  id="informes-filtro-texto"
                  type="text"
                  placeholder="Título, ID, operador, fecha de despacho..."
                  oninput="applyInformesFilters()"
                  class="mt-1 w-full p-2 border rounded-lg"
                />
              </div>
              <div>
                <label
                  for="informes-filtro-fecha-desde"
                  class="block text-sm font-medium text-gray-700"
                  >Despacho desde</label
                >
                <input
                  id="informes-filtro-fecha-desde"
                  type="date"
                  onchange="applyInformesFilters()"
                  class="mt-1 w-full p-2 border rounded-lg"
                />
              </div>
              <div>
                <label
                  for="informes-filtro-fecha-hasta"
                  class="block text-sm font-medium text-gray-700"
                  >Despacho hasta</label
                >
                <input
                  id="informes-filtro-fecha-hasta"
                  type="date"
                  onchange="applyInformesFilters()"
                  class="mt-1 w-full p-2 border rounded-lg"
                />
              </div>
              <div>
                <label
                  for="informes-filtro-operador"
                  class="block text-sm font-medium text-gray-700"
                  >Operador</label
                >
                <select
                  id="informes-filtro-operador"
                  onchange="applyInformesFilters()"
                  class="mt-1 w-full p-2 border rounded-lg"
                >
                  <option value="">Todos</option>
                </select>
              </div>
            </div>

            <div class="flex flex-wrap items-center justify-between mt-3 gap-3">
              <label
                class="inline-flex items-center gap-2 text-sm text-gray-700"
              >
                <input
                  id="informes-filtro-solo-incidencias"
                  type="checkbox"
                  onchange="applyInformesFilters()"
                  class="h-4 w-4"
                />
                Solo con incidencias
              </label>

              <div class="flex items-center gap-3">
                <p
                  id="informes-filtro-resumen"
                  class="text-sm text-gray-500"
                ></p>
                <button
                  type="button"
                  onclick="resetInformesFilters()"
                  class="bg-gray-200 text-gray-700 px-3 py-2 rounded-lg hover:bg-gray-300"
                >
                  Limpiar filtros
                </button>
              </div>
            </div>
          </div>

          <div id="informes-lista-container" class="overflow-x-auto">
            <div class="text-center p-6">
              <p class="text-gray-500">Cargando informes guardados...</p>
              <div
                class="inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-blue-500 mt-2"
              ></div>
            </div>
          </div>

          <!-- Modal para ver detalle del informe -->
          <div
            id="modal-informe-detalle"
            class="modal hidden fixed inset-0 flex items-center justify-center z-50 p-4"
          >
            <div
              class="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden"
            >
              <div class="flex justify-between items-center mb-4 p-6 border-b">
                <h3
                  class="text-xl font-bold text-gray-800"
                  id="modal-informe-titulo"
                ></h3>
                <div class="space-x-2">
                  <!-- <button
                    onclick="descargarInformeModal()"
                    class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm"
                  >
                    Descargar
                  </button> -->
                  <button
                    onclick="closeModal('modal-informe-detalle')"
                    class="text-gray-400 hover:text-gray-600"
                  >
                    <svg
                      class="w-6 h-6"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M6 18L18 6M6 6l12 12"
                      />
                    </svg>
                  </button>
                </div>
              </div>
              <div
                id="modal-informe-body"
                class="p-6 overflow-y-auto max-h-[60vh]"
              >
                <!-- El contenido del informe se cargará aquí -->
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal para Datos de Unidad -->
    <div
      id="data-modal"
      class="modal hidden fixed inset-0 flex items-center justify-center z-50 p-4"
    >
      <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-bold text-gray-800">Datos de Unidad</h3>
          <button
            onclick="closeModal('data-modal')"
            class="text-gray-400 hover:text-gray-600"
          >
            <svg
              class="w-6 h-6"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              />
            </svg>
          </button>
        </div>
        <div id="modal-body" class="text-gray-600"></div>
      </div>
    </div>

    <!-- SCRIPT PRINCIPAL -->
    <script>
      // --- CONFIG Y ESTADO GLOBAL ---
      Chart.register(ChartDataLabels);
      const API_KEY = "AIzaSyDtA5bl8XuclA92cz2f-eCswuWQul87f0I";
      const SPREADSHEET_ID = "1XwjnIxq98oStetgaD5XDWpfgUhMCR1dgCzY8eVa3tiE";
      const RANGE = "BITACORA!A1:S944";

      // --- FUNCIÓN SAFEFETCH MEJORADA ---
      function safeFetch(url, options = {}) {
        return fetch(url, options)
          .then((response) => {
            // Primero verificar si la respuesta es OK
            if (!response.ok) {
              throw new Error(
                `HTTP ${response.status}: ${response.statusText}`
              );
            }

            // Leer como texto primero para debug
            return response.text().then((text) => {
              // Intentar parsear como JSON
              try {
                const data = JSON.parse(text);
                return data;
              } catch (jsonError) {
                // Si hay error HTML, mostrar mensaje amigable
                if (
                  text.includes("<br") ||
                  text.includes("<b>") ||
                  text.includes("Fatal error")
                ) {
                  throw new Error(
                    "El servidor encontró un error interno. Por favor, intenta más tarde."
                  );
                }

                throw new Error("Respuesta del servidor no es válida");
              }
            });
          })
          .catch((error) => {
            throw error;
          });
      }

      let allDespachosData = [],
        filteredDespachosData = [],
        folioCounter = 1,
        charts = {},
        kpiVehicleData = {},
        lastInformeData = [];

      window.onload = function () {
        loadDataFromGoogleSheets(true);
        setInterval(() => loadDataFromGoogleSheets(false), 300000);
        changeTab(0);
      };

      // --- Helpers de fecha ---
      function excelDateToYYYYMMDD(value) {
        if (!value) return dayjs().format("YYYY-MM-DD");
        if (typeof value === "string" && /^\d{4}-\d{2}-\d{2}$/.test(value))
          return value;
        const parsedDash = dayjs(String(value), "DD-MM-YYYY");
        if (parsedDash.isValid()) return parsedDash.format("YYYY-MM-DD");
        const parsedSlash = dayjs(String(value), "DD/MM/YYYY");
        if (parsedSlash.isValid()) return parsedSlash.format("YYYY-MM-DD");
        if (value instanceof Date && !isNaN(value))
          return dayjs.utc(value).format("YYYY-MM-DD");
        return dayjs().format("YYYY-MM-DD");
      }

      function parseExcelDateTime(timeValue, dateValue) {
        if (!timeValue) return "";
        const fullDateTimeFormats = [
          "DD-MM-YYYY HH:mm:ss",
          "DD/MM/YYYY HH:mm:ss",
          "DD-MM-YYYY HH:mm",
          "DD/MM/YYYY HH:mm",
        ];
        let parsedDate = dayjs(String(timeValue), fullDateTimeFormats, true);
        if (!parsedDate.isValid()) {
          const mainDate = dayjs(
            String(dateValue),
            ["DD-MM-YYYY", "DD/MM/YYYY"],
            true
          );
          if (mainDate.isValid()) {
            const timeMatch = String(timeValue).match(
              /(\d{1,2}):(\d{2})(?::(\d{2}))?/
            );
            if (timeMatch) {
              const hours = parseInt(timeMatch[1], 10);
              const minutes = parseInt(timeMatch[2], 10);
              const seconds = timeMatch[3] ? parseInt(timeMatch[3], 10) : 0;
              parsedDate = mainDate.hour(hours).minute(minutes).second(seconds);
            }
          }
        }
        return parsedDate.isValid() ? parsedDate.toISOString() : "";
      }

      function formatDateTime(d) {
        return d && dayjs(d).isValid()
          ? dayjs(d).format("DD/MM/YYYY HH:mm")
          : "N/A";
      }

      function formatForInput(isoString) {
        if (!isoString) return "";
        try {
          const parsed = dayjs(isoString);
          if (!parsed.isValid()) return "";
          return parsed.format("YYYY-MM-DDTHH:mm");
        } catch (e) {
          return "";
        }
      }

      function checkTimeDeviation(prog, real) {
        if (!prog || !real) return "task-cell";
        const progDate = dayjs(prog);
        const realDate = dayjs(real);
        if (!progDate.isValid() || !realDate.isValid()) return "task-cell";
        const diff = realDate.diff(progDate, "minute");
        return diff > 10 ? "estatus-rojo" : "estatus-verde";
      }

      // --- Carga de Google Sheets ---
      async function loadDataFromGoogleSheets(isInitialLoad = true) {
        const container = document.getElementById("datos-generales-container");
        if (isInitialLoad) {
          container.innerHTML = `<div class="col-span-full text-center p-10 bg-white rounded-xl shadow"><h3 class="text-lg font-medium text-gray-700">Cargando datos...</h3><p class="text-gray-500 mt-2">Conectando con Google Sheets.</p></div>`;
        }
        try {
          const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${RANGE}?key=${API_KEY}`;
          const response = await fetch(url);
          const apiResponse = await response.json();
          if (!response.ok)
            throw new Error(
              apiResponse.error
                ? apiResponse.error.message
                : "Error de conexión."
            );
          if (!apiResponse.values || apiResponse.values.length === 0)
            throw new Error(
              `El RANGO ('${RANGE}') está vacío o es incorrecto.`
            );
          const jsonData = convertSheetDataToObjects(apiResponse.values);
          processData(jsonData);
        } catch (error) {
          container.innerHTML = `<div class="col-span-full text-center p-10 bg-white rounded-xl shadow"><h3 class="text-lg font-medium text-red-700">Error Crítico</h3><p class="mt-4 bg-red-50 p-3 rounded-md text-left"><strong>Detalle:</strong> ${error.message}</p></div>`;
        }
      }

      // --- Convertir Sheet a objetos ---
      function convertSheetDataToObjects(data) {
        if (data.length < 2) return [];
        const headers = data
          .shift()
          .map((h) => (typeof h === "string" ? h.trim().toLowerCase() : h));
        return data
          .map((row) => {
            const obj = {};
            headers.forEach((header, index) => {
              if (header) obj[header] = row[index] || "";
            });
            return obj;
          })
          .filter((row) => row.unidad && String(row.unidad).trim() !== "");
      }

      // --- Procesar datos (con nuevos campos) ---
      function processData(data) {
        // Mantener datos guardados en localStorage cuando existan
        let savedData = null;
        try {
          const local = localStorage.getItem("bitacoraData");
          if (local) savedData = JSON.parse(local);
        } catch (e) {
          localStorage.removeItem("bitacoraData");
        }
        const savedMap = new Map();
        if (savedData && Array.isArray(savedData)) {
          savedData.forEach((d) => {
            const key = `${d.folio}-${d.unidad}-${d.fechaProgramada}`;
            savedMap.set(key, d);
          });
        }

        folioCounter = 1;
        const newAll = data.map((row) => {
          const fechaProg = excelDateToYYYYMMDD(row["fecha"]);
          const despacho = {
            folio: row["folio"] || folioCounter++,
            fechaProgramada: fechaProg,
            unidad: row["unidad"] || "N/A",
            placas: row["placas"] || "N/A",
            operador: row["operador"] || "N/A",
            telefono: row["teléfono"] || "N/A",
            ruta: row["ruta"] || "N/A",
            origen: row["origen"] || "N/A",
            destino: row["destino"] || row["Destino"] || "N/A",
            citaSalidaUnidad: parseExcelDateTime(
              row["salida_prog"],
              row["fecha"]
            ),
            citaCarga: parseExcelDateTime(row["carga_prog"], row["fecha"]),
            citaSalida: parseExcelDateTime(
              row["salida_carga_prog"],
              row["fecha"]
            ),
            citaDescarga: parseExcelDateTime(
              row["descarga_prog"],
              row["fecha"]
            ),
            realSalidaUnidad: "",
            realCarga: "",
            realSalida: "",
            realDescarga: "",
            realConfirmacionEntrega: "",
            confirmacionEntrega: null,
            estatus: "Programado",
            incidencias: [],
            observaciones: "",
            observacionesTimestamp: "",
            // Nuevos campos
            operadorMonitoreoId: row["operador_monitoreo"] || "",
            gpsValidacionEstado: row["gps_validacion_estado"] || "",
            gpsValidacionTimestamp: row["gps_validacion_timestamp"] || "",
          };
          const key = `${despacho.folio}-${despacho.unidad}-${despacho.fechaProgramada}`;
          if (savedMap.has(key)) {
            const saved = savedMap.get(key);
            Object.assign(despacho, saved);
          }
          return despacho;
        });

        allDespachosData = newAll;
        saveAllData();

        const dateFilter = document.getElementById("date-filter");
        if (!dateFilter.value) setDefaultDate(dateFilter);
        filterByDate();
      }

      function saveAllData() {
        try {
          localStorage.setItem(
            "bitacoraData",
            JSON.stringify(allDespachosData)
          );
        } catch (e) {
          console.error("Error saving data", e);
        }
      }

      function setDefaultDate(dateFilter) {
        if (!dateFilter) return;
        if (allDespachosData.length > 0) {
          const allDates = [
            ...new Set(
              allDespachosData
                .map((d) => d.fechaProgramada)
                .filter((d) => d && dayjs(d, "YYYY-MM-DD").isValid())
            ),
          ];
          allDates.sort((a, b) =>
            dayjs(b, "YYYY-MM-DD").diff(dayjs(a, "YYYY-MM-DD"))
          );
          dateFilter.value =
            allDates.length > 0 ? allDates[0] : dayjs().format("YYYY-MM-DD");
        } else {
          dateFilter.value = dayjs().format("YYYY-MM-DD");
        }
      }

      function filterByDate() {
        const selectedDate = document.getElementById("date-filter").value;
        filteredDespachosData = allDespachosData.filter(
          (d) => d.fechaProgramada === selectedDate
        );
        renderAllTabs();
      }

      // --- Render de todas las pestañas ---
      function renderAllTabs() {
        renderDatosGenerales();
        renderOrigenDestino();
        populateUnidadSelector();
        populateRegistroFilter();
        renderRegistroDespacho();
        filterAndRenderKPIs("selectedDate");
        filterAndRenderInforme("selectedDate");
      }

      function renderDatosGenerales() {
        const container = document.getElementById("datos-generales-container");
        container.innerHTML = "";
        if (filteredDespachosData.length === 0) {
          container.innerHTML = `<div class="col-span-full text-center p-10 bg-white rounded-xl shadow"><h3 class="text-lg">No hay despachos para esta fecha</h3></div>`;
          return;
        }
        filteredDespachosData.forEach((d) => {
          container.innerHTML += `<div class="bg-white p-5 rounded-xl shadow-lg border border-gray-100"><div class="flex justify-between items-start mb-3"><div><h3 class="font-bold text-lg text-blue-800">${d.unidad}</h3><p class="text-sm text-gray-500">${d.placas}</p></div><span class="bg-blue-100 text-blue-800 text-xs font-semibold px-2.5 py-0.5 rounded-full">Folio: ${String(
            d.folio
          ).padStart(
            3,
            "0"
          )}</span></div><div class="space-y-2 text-sm"><p><strong>Operador:</strong> ${
            d.operador
          }</p><p><strong>Ruta:</strong> ${
            d.ruta
          }</p><p><strong>Destino:</strong> ${d.destino}</p></div></div>`;
        });
      }

      // --- Pestaña 2: Origen/Destino con hipervínculos a Google Maps ---
      function renderOrigenDestino() {
        const container = document.getElementById("origen-destino-container");
        container.innerHTML = "";
        if (filteredDespachosData.length === 0) {
          container.innerHTML = `<div class="col-span-full text-center p-10 bg-white rounded-xl shadow"><h3 class="text-lg">Sin datos de rutas</h3></div>`;
          return;
        }
        filteredDespachosData.forEach((d) => {
          const origenUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(
            d.origen || ""
          )}`;
          const destinoUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(
            d.destino || ""
          )}`;
          container.innerHTML += `
            <div class="bg-white p-5 rounded-xl shadow border">
              <h3 class="font-bold text-lg text-blue-800">${d.unidad}</h3>
              <p class="text-sm text-gray-500">${d.ruta}</p>
              <p class="text-sm mt-2">
                <strong>Origen:</strong>
                <a href="${origenUrl}" target="_blank" class="map-link">${
                  d.origen || "No especificado"
                }</a>
              </p>
              <p class="text-sm">
                <strong>Destino:</strong>
                <a href="${destinoUrl}" target="_blank" class="map-link">${
                  d.destino || "No especificado"
                }</a>
              </p>
            </div>`;
        });
      }

      // --- POBLAR SELECTOR DE UNIDADES ---
      function populateUnidadSelector() {
        const sel = document.getElementById("unidad-selector");
        sel.innerHTML = '<option value="">-- Seleccione unidad --</option>';
        filteredDespachosData.forEach((d, i) => {
          sel.innerHTML += `<option value="${i}">${d.unidad}</option>`;
        });
        document.getElementById("consulta-btn").disabled = true;
        sel.onchange = (ev) => handleUnidadSelection(ev);
      }

      function handleUnidadSelection(event) {
        const index = event.target.value;
        const consultaBtn = document.getElementById("consulta-btn");
        if (index === "" || index === null) {
          document
            .getElementById("seguimiento-form-container")
            .classList.add("hidden");
          consultaBtn.disabled = true;
          return;
        }
        consultaBtn.disabled = false;
        renderSeguimientoForm(Number(index));
      }

      // --- Pestaña 3: Seguimiento Detallado (con ID Operador y GPS) ---
      function renderSeguimientoForm(index) {
        const container = document.getElementById("seguimiento-form-container");
        const despacho = filteredDespachosData[index];
        if (!despacho) {
          container.innerHTML = "<p>No hay datos para esta unidad.</p>";
          container.classList.remove("hidden");
          return;
        }

        const incidenciaOptions = `
          <option>Robo o intento de robo del vehículo o la carga</option>
          <option>Choque, accidente o volcadura</option>
          <option>Pinchadura grave o reventón en carretera con detención total</option>
          <option>Pérdida total de señal GPS y comunicación durante más de 1 hora</option>
          <option>Emergencias médicas del conductor o acompañante</option>
          <option>Bloqueo de ruta por manifestaciones, inseguridad o siniestros naturales</option>
          <option>Fallo total del motor o sistema de frenos</option>
          <option>Desvío significativo de ruta sin justificación</option>
          <option>Parada prolongada no programada</option>
          <option>Pérdida temporal de comunicación GPS (más de 30 min)</option>
          <option>Avería mecánica menor</option>
          <option>Parada en punto no autorizado</option>
          <option>Conductor no responde llamadas</option>
          <option>Mercancía rechazada</option>
          <option>Mal tiempo</option>
          <option>Ponchadura de llanta</option>
        `;

        container.innerHTML = `
          <form id="form-seguimiento" class="space-y-6">
            <!-- SECCIÓN SUPERIOR: OPERADOR & VALIDACIÓN GPS -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 justify-items-center text-center">
              <!-- ID del Operador de Monitoreo -->
              <div class="bg-gray-50 border rounded-xl px-4 py-3 w-full max-w-md shadow-sm">
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                  ID del Operador de Monitoreo
                </label>
                <select
                  name="operadorMonitoreoId"
                  class="mt-1 w-full max-w-xs mx-auto p-2 border rounded-md"
                >
                  <option value="">-- Seleccione --</option>
                  <option value="GEO-01" ${
                    despacho.operadorMonitoreoId === "GEO-01" ? "selected" : ""
                  }>GEO-01</option>
                  <option value="GEO-02" ${
                    despacho.operadorMonitoreoId === "GEO-02" ? "selected" : ""
                  }>GEO-02</option>
                  <option value="GEO-03" ${
                    despacho.operadorMonitoreoId === "GEO-03" ? "selected" : ""
                  }>GEO-03</option>
                  <option value="GEO-04" ${
                    despacho.operadorMonitoreoId === "GEO-04" ? "selected" : ""
                  }>GEO-04</option>
                  <option value="GEO-05" ${
                    despacho.operadorMonitoreoId === "GEO-05" ? "selected" : ""
                  }>GEO-05</option>
                  <option value="GEO-06" ${
                    despacho.operadorMonitoreoId === "GEO-06" ? "selected" : ""
                  }>GEO-06</option>
                </select>
              </div>

              <!-- Validación de Funcionamiento del GPS y accesorios -->
              <div class="bg-gray-50 border rounded-xl px-4 py-3 w-full max-w-md shadow-sm">
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                  Validación de Funcionamiento del GPS y accesorios
                </label>
                <select
                  name="gpsValidacionEstado"
                  class="mt-1 w-full max-w-xs mx-auto p-2 border rounded-md"
                  onchange="handleGpsValidationChange(${index}, this)"
                >
                  <option value="">-- Seleccione --</option>
                  <option value="Operativo" ${
                    despacho.gpsValidacionEstado === "Operativo"
                      ? "selected"
                      : ""
                  }>Operativo</option>
                  <option value="No Operativo" ${
                    despacho.gpsValidacionEstado === "No Operativo"
                      ? "selected"
                      : ""
                  }>No Operativo</option>
                </select>
                <p class="mt-2 text-xs text-gray-500">
                  Última validación:
                  <span id="gps-validacion-timestamp-${index}" class="font-semibold">
                    ${
                      despacho.gpsValidacionTimestamp
                        ? formatDateTime(despacho.gpsValidacionTimestamp)
                        : "Sin registro"
                    }
                  </span>
                </p>
              </div>
            </div>

            <!-- BLOQUE DE TIEMPOS (REAL) -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <!-- SALIDA INICIAL DE LA UNIDAD -->
              <div>
                <label class="block text-sm font-medium text-gray-700">
                  Salida inicial de la Unidad (Real)
                </label>
                <input name="realSalidaUnidad" type="datetime-local"
                  value="${formatForInput(despacho.realSalidaUnidad)}"
                  class="mt-1 w-full p-2 border rounded-md" />

                <div class="mt-2 p-2 bg-gray-100 border border-gray-300 rounded-md text-sm text-gray-700">
                  <strong>Programada:</strong> ${formatDateTime(
                    despacho.citaSalidaUnidad
                  )}
                </div>
              </div>

              <!-- CITA DE CARGA (REAL) -->
              <div>
                <label class="block text-sm font-medium text-gray-700">
                  Cita de Carga (Real)
                </label>
                <input name="realCarga" type="datetime-local"
                  value="${formatForInput(despacho.realCarga)}"
                  class="mt-1 w-full p-2 border rounded-md" />

                <div class="mt-2 p-2 bg-gray-100 border border-gray-300 rounded-md text-sm text-gray-700">
                  <strong>Programada:</strong> ${formatDateTime(
                    despacho.citaCarga
                  )}
                </div>
              </div>

              <!-- SALIDA DE CARGA (REAL) -->
              <div>
                <label class="block text-sm font-medium text-gray-700">
                  Salida de carga (Real)
                </label>
                <input name="realSalida" type="datetime-local"
                  value="${formatForInput(despacho.realSalida)}"
                  class="mt-1 w-full p-2 border rounded-md" />

                <div class="mt-2 p-2 bg-gray-100 border border-gray-300 rounded-md text-sm text-gray-700">
                  <strong>Programada:</strong> ${formatDateTime(
                    despacho.citaSalida
                  )}
                </div>
              </div>

              <!-- PROCESO DE DESCARGA (REAL) -->
              <div>
                <label class="block text-sm font-medium text-gray-700">
                  Proceso de Descarga (Real)
                </label>
                <input name="realDescarga" type="datetime-local"
                  value="${formatForInput(despacho.realDescarga)}"
                  class="mt-1 w-full p-2 border rounded-md" />

                <div class="mt-2 p-2 bg-gray-100 border border-gray-300 rounded-md text-sm text-gray-700">
                  <strong>Programada:</strong> ${formatDateTime(
                    despacho.citaDescarga
                  )}
                </div>
              </div>
            </div>

            <!-- CONFIRMACIÓN Y ESTATUS DEL DESPACHO -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium">
                  Confirmación de Entrega Despacho
                </label>
                <select name="confirmacionEntregaSelect" class="mt-1 w-full p-2 border rounded-md">
                  <option value="">-- Seleccione --</option>
                  <option value="SI" ${
                    despacho.confirmacionEntrega === "SI" ? "selected" : ""
                  }>SI</option>
                  <option value="NO" ${
                    despacho.confirmacionEntrega === "NO" ? "selected" : ""
                  }>NO</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium">
                  Estatus del proceso de Despacho
                </label>
                <select name="estatus" class="mt-1 w-full p-2 border rounded-md">
                  <option ${
                    despacho.estatus === "Programado" ? "selected" : ""
                  }>Programado</option>
                  <option ${
                    despacho.estatus === "En ruta" ? "selected" : ""
                  }>En ruta</option>
                  <option ${
                    despacho.estatus === "Despacho realizado" ? "selected" : ""
                  }>Despacho realizado</option>
                  <option ${
                    despacho.estatus === "Despacho No realizado"
                      ? "selected"
                      : ""
                  }>Despacho No realizado</option>
                </select>
              </div>
            </div>

            <!-- OBSERVACIONES -->
            <div>
              <label class="block text-sm font-medium">Observaciones</label>
              <textarea name="observaciones" rows="3" class="mt-1 w-full p-2 border rounded-md">${
                despacho.observaciones || ""
              }</textarea>
            </div>

            <!-- INCIDENCIAS + BOTÓN GUARDAR -->
            <div class="mt-4 border-t pt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium">Registrar Incidencia</label>
                <div class="flex gap-2 mt-2">
                  <select id="incidencia-tipo" class="p-2 border rounded-md w-full">${incidenciaOptions}</select>
                  <button type="button" onclick="addIncidencia(${index})" class="bg-slate-700 text-white px-4 py-2 rounded-md hover:bg-slate-800">
                    Agregar
                  </button>
                </div>
                <div id="incidencias-list" class="mt-4 space-y-2">
                  ${renderIncidencias(despacho.incidencias)}
                </div>
              </div>

              <div>
                <div class="text-sm text-gray-600 mb-2">
                  <strong>Nota:</strong> Las incidencias se guardan automáticamente en localStorage y se incluyen en reportes y KPIs.
                </div>
                <div class="mt-6 text-right">
                  <button type="button" onclick="saveSeguimiento(${index})" class="bg-indigo-600 text-white px-6 py-2 rounded-lg">
                    Guardar Cambios
                  </button>
                </div>
              </div>
            </div>
          </form>
        `;
        container.classList.remove("hidden");
      }

      // --- Cambio de estado GPS (marca fecha/hora) ---
      function handleGpsValidationChange(index, selectEl) {
        if (
          typeof index !== "number" ||
          index < 0 ||
          index >= filteredDespachosData.length
        ) {
          return;
        }

        const d = filteredDespachosData[index];
        const newValue = selectEl.value;

        d.gpsValidacionEstado = newValue || "";
        d.gpsValidacionTimestamp = newValue ? new Date().toISOString() : "";

        saveAllData();

        const span = document.getElementById(
          `gps-validacion-timestamp-${index}`
        );
        if (span) {
          span.textContent = newValue
            ? formatDateTime(d.gpsValidacionTimestamp)
            : "Sin registro";
        }
      }

      // --- renderIncidencias ---
      function renderIncidencias(incidencias) {
        if (!incidencias || incidencias.length === 0)
          return '<p class="text-sm text-gray-500">No hay incidencias.</p>';
        return incidencias
          .map(
            (inc) =>
              `<div class="text-sm p-2 rounded-md incidencia-${inc.severidad.toLowerCase()}"><strong>${
                inc.tipo
              }</strong> - ${formatDateTime(inc.fecha)}</div>`
          )
          .join("");
      }

      // --- Agregar incidencia ---
      function addIncidencia(index) {
        const sel = document.getElementById("incidencia-tipo");
        if (!sel) return;
        const tipo = sel.value;
        if (!tipo) {
          alert("Seleccione un tipo de incidencia.");
          return;
        }

        const severidadMap = {
          "Robo o intento de robo del vehículo o la carga": "Rojo",
          "Choque, accidente o volcadura": "Rojo",
          "Pinchadura grave o reventón en carretera con detención total":
            "Rojo",
          "Pérdida total de señal GPS y comunicación durante más de 1 hora":
            "Rojo",
          "Emergencias médicas del conductor o acompañante": "Rojo",
          "Bloqueo de ruta por manifestaciones, inseguridad o siniestros naturales":
            "Rojo",
          "Fallo total del motor o sistema de frenos": "Rojo",
          "Desvío significativo de ruta sin justificación": "Naranja",
          "Parada prolongada no programada": "Naranja",
          "Pérdida temporal de comunicación GPS (más de 30 min)": "Naranja",
          "Avería mecánica menor": "Naranja",
          "Parada en punto no autorizado": "Naranja",
          "Conductor no responde llamadas": "Naranja",
          "Mercancía rechazada": "Naranja",
          "Mal tiempo": "Naranja",
          "Ponchadura de llanta": "Naranja",
        };

        if (
          typeof index !== "number" ||
          index < 0 ||
          index >= filteredDespachosData.length
        ) {
          alert("Unidad no seleccionada correctamente.");
          return;
        }

        const tipoSeleccionado = tipo;
        const severidad = severidadMap[tipoSeleccionado] || "Verde";

        filteredDespachosData[index].incidencias.push({
          tipo: tipoSeleccionado,
          fecha: new Date().toISOString(),
          severidad: severidad,
        });

        saveAllData();
        document.getElementById("incidencias-list").innerHTML =
          renderIncidencias(filteredDespachosData[index].incidencias);
        renderRegistroDespacho();
        filterAndRenderKPIs("selectedDate");
        filterAndRenderInforme("selectedDate");
      }

      // --- Guardado del seguimiento ---
      function saveSeguimiento(index) {
        const form = document.getElementById("form-seguimiento");
        if (!form) return alert("Formulario no encontrado.");
        const d = filteredDespachosData[index];

        d.realCarga = form.elements["realCarga"].value;
        d.realSalida = form.elements["realSalida"].value;
        d.realDescarga = form.elements["realDescarga"].value;
        d.realSalidaUnidad = form.elements["realSalidaUnidad"].value;

        // Nuevo: ID del operador de monitoreo
        if (form.elements["operadorMonitoreoId"]) {
          d.operadorMonitoreoId =
            form.elements["operadorMonitoreoId"].value || "";
        }

        // Asegurar estado de validación GPS
        const prevGpsEstado = d.gpsValidacionEstado || "";
        const newGpsEstado = form.elements["gpsValidacionEstado"]
          ? form.elements["gpsValidacionEstado"].value || ""
          : prevGpsEstado;

        if (newGpsEstado !== prevGpsEstado) {
          d.gpsValidacionEstado = newGpsEstado;
          d.gpsValidacionTimestamp = newGpsEstado
            ? new Date().toISOString()
            : "";
        }

        const nuevaConfirmacion =
          form.elements["confirmacionEntregaSelect"].value;
        if (nuevaConfirmacion && d.confirmacionEntrega !== nuevaConfirmacion)
          d.realConfirmacionEntrega = new Date().toISOString();
        else if (!nuevaConfirmacion && d.confirmacionEntrega)
          d.realConfirmacionEntrega = "";

        d.confirmacionEntrega = nuevaConfirmacion || null;

        const newObservaciones = form.elements["observaciones"].value;
        if (newObservaciones && d.observaciones !== newObservaciones)
          d.observacionesTimestamp = new Date().toISOString();
        else if (!newObservaciones) d.observacionesTimestamp = "";
        d.observaciones = newObservaciones;

        const estatusSelect = form.elements["estatus"];
        if (d.confirmacionEntrega === "SI") d.estatus = "Despacho realizado";
        else if (d.confirmacionEntrega === "NO")
          d.estatus = "Despacho No realizado";
        else if (
          d.realSalidaUnidad ||
          d.realCarga ||
          d.realSalida ||
          d.realDescarga
        )
          d.estatus = "En ruta";
        else d.estatus = estatusSelect.value;

        saveAllData();
        alert("Datos guardados para la unidad " + d.unidad);
        renderAllTabs();
        document.getElementById("unidad-selector").value = index;
        renderSeguimientoForm(index);
      }

      // --- Pestaña 4: Matriz / Registro ---
      function populateRegistroFilter() {
        const selector = document.getElementById("registro-unidad-filter");
        selector.innerHTML = '<option value="all">Mostrar Todas</option>';
        filteredDespachosData.forEach((d, i) => {
          selector.innerHTML += `<option value="${i}">${d.unidad}</option>`;
        });
      }

      function renderRegistroDespacho() {
        const container = document.getElementById("registro-board-container");
        const filter = document.getElementById("registro-unidad-filter");
        container.innerHTML = "";
        let dataToRender = filteredDespachosData;
        if (filter && filter.value !== "all") {
          dataToRender = [filteredDespachosData[filter.value]];
        }
        if (!dataToRender || dataToRender.length === 0 || !dataToRender[0]) {
          container.innerHTML = `<div class="text-center p-6">No hay despachos para mostrar.</div>`;
          return;
        }
        const board = document.createElement("div");
        board.className = "registro-board";
        // Header row (títulos igual que pestaña 3)
        const headerRow = document.createElement("div");
        headerRow.className = "board-row font-bold text-gray-600";
        [
          "Unidad",
          "Salida inicial de la Unidad",
          "Proceso de Carga",
          "Salida de carga",
          "Proceso de Descarga",
          "Estatus del proceso de Despacho",
        ].forEach((h) => {
          const cell = document.createElement("div");
          cell.className = "board-cell";
          cell.textContent = h;
          headerRow.appendChild(cell);
        });
        board.appendChild(headerRow);
        // Rows
        dataToRender.forEach((d) => {
          const row = document.createElement("div");
          row.className = "board-row";
          // Unidad cell
          const uc = document.createElement("div");
          uc.className = "board-cell unit-cell";
          uc.innerHTML = `<strong>${d.unidad}</strong><div class="text-xs">${d.placas}</div>`;
          row.appendChild(uc);
          // tasks: salida unidad, carga, salida, descarga
          const tasks = [
            { cita: d.citaSalidaUnidad, real: d.realSalidaUnidad },
            { cita: d.citaCarga, real: d.realCarga },
            { cita: d.citaSalida, real: d.realSalida },
            { cita: d.citaDescarga, real: d.realDescarga },
          ];
          tasks.forEach((task) => {
            const taskCell = document.createElement("div");
            const bgColorClass = task.real
              ? checkTimeDeviation(task.cita, task.real) === "estatus-rojo"
                ? "estatus-rojo"
                : "estatus-verde"
              : "task-cell";
            taskCell.className = `board-cell ${bgColorClass}`;
            taskCell.innerHTML = `<p class="text-xs">${formatDateTime(
              task.cita
            )}</p><p class="font-semibold">${
              task.real ? formatDateTime(task.real) : "-"
            }</p>`;
            row.appendChild(taskCell);
          });
          // Estatus del proceso de Despacho con colores
          const statusCell = document.createElement("div");
          let statusClass = "task-cell";
          if (d.estatus === "En ruta") statusClass = "estatus-en-ruta";
          else if (d.estatus === "Despacho realizado")
            statusClass = "estatus-verde";
          else if (d.estatus === "Despacho No realizado")
            statusClass = "estatus-rojo";
          // Programado se queda gris (task-cell)
          statusCell.className = `board-cell ${statusClass}`;
          statusCell.textContent = d.estatus || "Sin estatus";
          row.appendChild(statusCell);
          board.appendChild(row);
        });
        container.appendChild(board);
      }

      // --- Charts: cumplimiento e incidencias ---
      const centerTextPlugin = {
        id: "centerText",
        beforeDraw: (chart) => {
          if (chart.config.type !== "doughnut") return;
          const {
            ctx,
            chartArea: { top, width, height },
          } = chart;
          const total = chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
          if (total === 0) return;
          ctx.save();
          ctx.font = "bold 24px Inter";
          ctx.fillStyle = "#374151";
          ctx.textAlign = "center";
          ctx.textBaseline = "middle";
          ctx.fillText(total, width / 2, top + height / 2);
          ctx.font = "normal 12px Inter";
          ctx.fillStyle = "#6b7280";
          ctx.fillText("TOTAL", width / 2, top + height / 2 + 20);
          ctx.restore();
        },
      };

      function updateCumplimientoChart(
        despachosATiempo,
        despachosConRetraso,
        despachosEnRuta,
        despachosProgramados
      ) {
        const ctx = document
          .getElementById("kpi-cumplimiento-chart")
          .getContext("2d");
        if (charts.cumplimiento) charts.cumplimiento.destroy();
        charts.cumplimiento = new Chart(ctx, {
          type: "bar",
          data: {
            labels: ["A Tiempo", "Con Retraso", "En Ruta", "Programados"],
            datasets: [
              {
                data: [
                  despachosATiempo.length,
                  despachosConRetraso.length,
                  despachosEnRuta.length,
                  despachosProgramados.length,
                ],
                backgroundColor: ["#22c55e", "#ef4444", "#f59e0b", "#6b7280"],
                borderRadius: 4,
                barThickness: 30,
              },
            ],
          },
          options: {
            indexAxis: "y",
            responsive: true,
            scales: {
              x: {
                grid: { borderColor: "#e5e7eb", color: "#f3f4f6" },
                ticks: { font: { size: 12 } },
              },
              y: {
                grid: { display: false },
                ticks: { font: { size: 12 } },
              },
            },
            plugins: {
              legend: { display: false },
              datalabels: {
                anchor: "end",
                align: "right",
                offset: 8,
                color: "#1f2937",
                font: { size: 14, weight: "600" },
              },
            },
          },
        });
      }

      function updateIncidenciasChart(data) {
        const ctx = document.getElementById("kpi-incidencias-chart");
        if (!ctx) return;
        if (charts.incidencias) charts.incidencias.destroy();
        const labels = Object.keys(data);
        const values = Object.values(data);
        if (labels.length === 0) {
          charts.incidencias = new Chart(ctx, {
            type: "doughnut",
            data: {
              labels: ["Sin incidencias"],
              datasets: [{ data: [1], backgroundColor: ["#e5e7eb"] }],
            },
            options: {
              responsive: true,
              plugins: { legend: { display: false } },
            },
          });
          return;
        }
        charts.incidencias = new Chart(ctx, {
          type: "doughnut",
          data: {
            labels: labels,
            datasets: [
              {
                data: values,
                backgroundColor: [
                  "#ef4444",
                  "#f97316",
                  "#22c55e",
                  "#3b82f6",
                  "#6366f1",
                  "#8b5cf6",
                  "#f472b6",
                  "#10b981",
                ],
                borderColor: "#fff",
                borderWidth: 4,
                hoverOffset: 8,
              },
            ],
          },
          options: {
            responsive: true,
            cutout: "70%",
            plugins: {
              legend: {
                position: "bottom",
                labels: { usePointStyle: true, pointStyle: "circle" },
              },
              tooltip: {
                callbacks: {
                  label: (context) => ` ${context.label}: ${context.raw}`,
                },
              },
            },
          },
          plugins: [centerTextPlugin],
        });
      }

      function updateKPIs(data) {
        const total = data.length;
        const despachosRealizados = data.filter(
          (d) => d.estatus === "Despacho realizado"
        );
        const despachosATiempo = despachosRealizados.filter(
          (d) => d.confirmacionEntrega === "SI"
        );
        const despachosConRetraso =
          despachosRealizados.length - despachosATiempo.length;
        const despachosEnRuta = data.filter((d) => d.estatus === "En ruta");
        const despachosProgramados = data.filter(
          (d) => d.estatus === "Programado"
        );

        kpiVehicleData = {
          aTiempo: despachosATiempo.map((d) => d.unidad),
          conRetraso: despachosRealizados
            .filter((d) => !(d.confirmacionEntrega === "SI"))
            .map((d) => d.unidad),
          enRuta: despachosEnRuta.map((d) => d.unidad),
          programados: despachosProgramados.map((d) => d.unidad),
        };

        document.getElementById("kpi-total-despachos").textContent = total;
        document.getElementById("kpi-despachos-a-tiempo").textContent =
          despachosATiempo.length;
        document.getElementById("kpi-despachos-retraso").textContent =
          despachosConRetraso;
        document.getElementById("kpi-despachos-en-ruta").textContent =
          despachosEnRuta.length;
        document.getElementById("kpi-despachos-programados").textContent =
          despachosProgramados.length;

        updateCumplimientoChart(
          despachosATiempo,
          despachosRealizados.filter((d) => !(d.confirmacionEntrega === "SI")),
          despachosEnRuta,
          despachosProgramados
        );

        const incidenciasCount = {};
        data.forEach((d) =>
          d.incidencias.forEach((inc) => {
            incidenciasCount[inc.tipo] = (incidenciasCount[inc.tipo] || 0) + 1;
          })
        );
        updateIncidenciasChart(incidenciasCount);
      }

      // --- KPIs: filtro por rango ---
      function filterAndRenderKPIs(range, event) {
        const today = dayjs();
        let dataForRange;
        const selected = dayjs(document.getElementById("date-filter").value);
        if (range === "selectedDate")
          dataForRange = allDespachosData.filter((d) =>
            dayjs(d.fechaProgramada).isSame(selected, "day")
          );
        else if (range === "today")
          dataForRange = allDespachosData.filter((d) =>
            dayjs(d.fechaProgramada).isSame(today, "day")
          );
        else if (range === "week")
          dataForRange = allDespachosData.filter((d) =>
            dayjs(d.fechaProgramada).isAfter(today.subtract(7, "day"))
          );
        else if (range === "month")
          dataForRange = allDespachosData.filter((d) =>
            dayjs(d.fechaProgramada).isAfter(today.subtract(30, "day"))
          );

        updateKPIs(dataForRange || allDespachosData);

        document
          .querySelectorAll("#kpi-filter-buttons .kpi-filter-btn")
          .forEach((btn) => btn.classList.remove("kpi-filter-btn-active"));
        if (event) event.target.classList.add("kpi-filter-btn-active");
        else
          document
            .querySelector("#kpi-filter-buttons .kpi-filter-btn")
            ?.classList.add("kpi-filter-btn-active");
      }

      // --- Informe Ejecutivo (pestaña 6) ---
      function filterAndRenderInforme(range, event) {
        let dataForRange;
        const today = dayjs();
        const selected = dayjs(document.getElementById("date-filter").value);
        if (range === "selectedDate")
          dataForRange = allDespachosData.filter((d) =>
            dayjs(d.fechaProgramada).isSame(selected, "day")
          );
        else if (range === "today")
          dataForRange = allDespachosData.filter((d) =>
            dayjs(d.fechaProgramada).isSame(today, "day")
          );
        else if (range === "week")
          dataForRange = allDespachosData.filter((d) =>
            dayjs(d.fechaProgramada).isAfter(today.subtract(7, "day"))
          );
        else if (range === "month")
          dataForRange = allDespachosData.filter((d) =>
            dayjs(d.fechaProgramada).isAfter(today.subtract(30, "day"))
          );
        renderInforme(dataForRange || allDespachosData);
      }

      function renderInforme(data) {
        const container = document.getElementById("informe-container");
        const btnWord = document.getElementById("download-report-btn");
        const btnExcel = document.getElementById("download-excel-report-btn");

        if (!data || data.length === 0) {
          container.innerHTML = `<p class="text-center p-6 bg-gray-100 rounded-lg">No hay datos para generar un informe.</p>`;
          if (btnWord) btnWord.disabled = true;
          if (btnExcel) btnExcel.disabled = true;
          lastInformeData = [];
          return;
        }

        lastInformeData = data.slice();
        if (btnWord) btnWord.disabled = false;
        if (btnExcel) btnExcel.disabled = false;

        const total = data.length;
        const realizados = data.filter(
          (d) => d.estatus === "Despacho realizado"
        );
        const aTiempo = realizados.filter(
          (d) =>
            d.realDescarga &&
            checkTimeDeviation(d.citaDescarga, d.realDescarga) ===
              "estatus-verde"
        ).length;
        const conRetraso = realizados.length - aTiempo;
        const totalIncidencias = data.reduce(
          (acc, d) => acc + d.incidencias.length,
          0
        );

        let html = `<div id="report-content-for-download">
          <h2 class="text-xl font-bold mb-4">Informe de Despachos</h2>
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-gray-100 p-4 rounded-lg text-center">
              <p class="text-sm font-medium">Total</p>
              <p class="text-2xl font-bold">${total}</p>
            </div>
            <div class="bg-green-100 p-4 rounded-lg text-center">
              <p class="text-sm font-medium">A Tiempo</p>
              <p class="text-2xl font-bold">${aTiempo}</p>
            </div>
            <div class="bg-red-100 p-4 rounded-lg text-center">
              <p class="text-sm font-medium">Retraso</p>
              <p class="text-2xl font-bold">${conRetraso}</p>
            </div>
            <div class="bg-orange-100 p-4 rounded-lg text-center">
              <p class="text-sm font-medium">Incidencias</p>
              <p class="text-2xl font-bold">${totalIncidencias}</p>
            </div>
          </div>

          <h3 class="text-lg font-semibold mb-4">Detalle de Viajes</h3>
          <table class="min-w-full divide-y divide-gray-200 text-sm mb-8">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-4 py-2 text-left">Unidad</th>
                <th class="px-4 py-2 text-left">Ruta</th>
                <th class="px-4 py-2 text-left">Estatus</th>
                <th class="px-4 py-2 text-left">Prog. Descarga</th>
                <th class="px-4 py-2 text-left">Real Descarga</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y">`;

        data.forEach((d) => {
          const statusClass = d.realDescarga
            ? checkTimeDeviation(d.citaDescarga, d.realDescarga)
            : "task-cell";
          html += `<tr>
            <td class="px-4 py-2 font-semibold">${d.unidad}</td>
            <td class="px-4 py-2">${d.ruta}</td>
            <td class="px-4 py-2">${d.estatus}</td>
            <td class="px-4 py-2">${formatDateTime(d.citaDescarga)}</td>
            <td class="px-4 py-2 font-semibold ${statusClass}">${formatDateTime(
              d.realDescarga
            )}</td>
          </tr>`;
        });

        html += `</tbody></table>`;

        // Incidencias con color (como pestaña 3)
        let incidenciasRows = "";
        data.forEach((d) => {
          if (d.incidencias && d.incidencias.length > 0) {
            d.incidencias.forEach((inc) => {
              const sevClass =
                inc.severidad === "Rojo"
                  ? "incidencia-rojo"
                  : inc.severidad === "Naranja"
                    ? "incidencia-naranja"
                    : "incidencia-verde";

              incidenciasRows += `<tr class="${sevClass}">
                <td class="px-4 py-2 font-semibold">${d.unidad}</td>
                <td class="px-4 py-2">${d.ruta}</td>
                <td class="px-4 py-2">${inc.tipo}</td>
                <td class="px-4 py-2">${inc.severidad}</td>
                <td class="px-4 py-2">${formatDateTime(inc.fecha)}</td>
              </tr>`;
            });
          }
        });

        if (incidenciasRows) {
          html += `
            <h3 class="text-lg font-semibold mb-4">Incidencias registradas por vehículo</h3>
            <table class="min-w-full divide-y divide-gray-200 text-sm">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-4 py-2 text-left">Unidad</th>
                  <th class="px-4 py-2 text-left">Ruta</th>
                  <th class="px-4 py-2 text-left">Tipo de Incidencia</th>
                  <th class="px-4 py-2 text-left">Nivel de Criticidad</th>
                  <th class="px-4 py-2 text-left">Fecha de Registro</th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y">
                ${incidenciasRows}
              </tbody>
            </table>
          `;
        } else {
          html += `<p class="mt-4 text-sm text-gray-500">No se registraron incidencias en este periodo.</p>`;
        }

        html += `</div>`;
        container.innerHTML = html;
      }

      // --- Exportación principal XLSX ---
      function exportUpdatedSheet() {
        if (allDespachosData.length === 0) {
          alert("No hay datos para exportar.");
          return;
        }
        const dataToExport = allDespachosData.map((d) => ({
          Fecha: d.fechaProgramada
            ? dayjs(d.fechaProgramada).format("DD/MM/YYYY")
            : "",
          Folio: d.folio,
          Unidad: d.unidad,
          Placas: d.placas,
          Operador: d.operador,
          Móvil: d.telefono,
          Ruta: d.ruta,
          Origen: d.origen,
          Destino: d.destino,
          "Salida de la unidad": formatDateTime(d.citaSalidaUnidad),
          "Real Salida de la unidad": formatDateTime(d.realSalidaUnidad),
          "Cita de Carga": formatDateTime(d.citaCarga),
          "Real Cita de Carga": formatDateTime(d.realCarga),
          "Salida de Carga": formatDateTime(d.citaSalida),
          "Real Salida de Carga": formatDateTime(d.realSalida),
          "Cita de Descarga": formatDateTime(d.citaDescarga),
          "Real Cita de Descarga": formatDateTime(d.realDescarga),
          "Confirmacion de Entrega de Carga": d.confirmacionEntrega,
          Estatus: d.estatus,
          Incidencias: d.incidencias
            .map((i) => `${i.tipo} (${formatDateTime(i.fecha)})`)
            .join("; "),
          Observaciones: d.observaciones,
          "ID Operador Monitoreo": d.operadorMonitoreoId || "",
          "Estado GPS/Accesorios": d.gpsValidacionEstado || "",
          "Fecha Validación GPS": d.gpsValidacionTimestamp
            ? formatDateTime(d.gpsValidacionTimestamp)
            : "",
        }));
        const worksheet = XLSX.utils.json_to_sheet(dataToExport);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(
          workbook,
          worksheet,
          "Bitacora Actualizada"
        );
        XLSX.writeFile(
          workbook,
          `Bitacora_Actualizada_${dayjs().format("YYYY-MM-DD")}.xlsx`
        );
      }

      // --- Navegación de pestañas y modal ---
      function changeTab(index) {
        document.querySelectorAll(".tab-btn").forEach((tab, i) => {
          const content = document.getElementById(`tab-${i}`);
          tab.classList.toggle("tab-active", i === index);
          tab.classList.toggle("text-gray-500", i !== index);
          if (content) content.classList.toggle("hidden", i !== index);
        });
        if (index === 4) filterAndRenderKPIs("selectedDate");
        if (index === 5) filterAndRenderInforme("selectedDate");
      }

      function openModal(modalId) {
        document.getElementById(modalId).classList.remove("hidden");
      }
      function closeModal(modalId) {
        document.getElementById(modalId).classList.add("hidden");
      }
      window.onclick = function (event) {
        if (event.target.classList.contains("modal"))
          event.target.classList.add("hidden");
      };

      function showUnitData() {
        const selector = document.getElementById("unidad-selector");
        const index = selector.value;
        if (index === "") return;
        const d = filteredDespachosData[index];
        document.getElementById("modal-body").innerHTML =
          `<div class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
          <p><strong>Folio:</strong></p><p>${String(d.folio).padStart(
            3,
            "0"
          )}</p>
          <p><strong>Unidad:</strong></p><p>${d.unidad}</p>
          <p><strong>Placas:</strong></p><p>${d.placas}</p>
          <p><strong>Operador:</strong></p><p>${d.operador}</p>
          <p><strong>Teléfono:</strong></p><p>${d.telefono}</p>
          <p><strong>Ruta:</strong></p><p>${d.ruta}</p>
          <p><strong>Origen:</strong></p><p>${d.origen}</p>
          <p><strong>Destino:</strong></p><p>${d.destino}</p>
        </div>`;
        openModal("data-modal");
      }

      // --- Descargar informe DOC ---
      function downloadWordReport() {
        const container = document.getElementById(
          "report-content-for-download"
        );
        if (!container) {
          alert("No hay contenido de informe para descargar.");
          return;
        }

        const contenido = `
          <html>
            <head>
              <meta charset="UTF-8">
              <title>Informe de Despachos</title>
            </head>
            <body>
              ${container.innerHTML}
            </body>
          </html>
        `;

        const blob = new Blob(["\ufeff", contenido], {
          type: "application/msword",
        });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url;
        link.download = `Informe_Despachos_${dayjs().format("YYYY-MM-DD")}.doc`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
      }

      // --- Descargar informe detallado XLSX ---
      function downloadReportAsExcel() {
        if (!lastInformeData || lastInformeData.length === 0) {
          alert("No hay datos de informe para exportar.");
          return;
        }

        const rows = [];

        lastInformeData.forEach((d) => {
          // Fila principal del viaje
          rows.push({
            Fecha: d.fechaProgramada
              ? dayjs(d.fechaProgramada).format("DD/MM/YYYY")
              : "",
            Folio: d.folio,
            Unidad: d.unidad,
            Placas: d.placas,
            Operador: d.operador,
            Ruta: d.ruta,
            Origen: d.origen,
            Destino: d.destino,
            Estatus: d.estatus,
            "Prog. Descarga": formatDateTime(d.citaDescarga),
            "Real Descarga": formatDateTime(d.realDescarga),
            "ID Operador Monitoreo": d.operadorMonitoreoId || "",
            "Estado GPS/Accesorios": d.gpsValidacionEstado || "",
            "Fecha Validación GPS": d.gpsValidacionTimestamp
              ? formatDateTime(d.gpsValidacionTimestamp)
              : "",
            "Total Incidencias": d.incidencias ? d.incidencias.length : 0,
          });

          // Filas adicionales por cada incidencia de ese viaje
          if (d.incidencias && d.incidencias.length > 0) {
            d.incidencias.forEach((inc) => {
              rows.push({
                Fecha: "",
                Folio: d.folio,
                Unidad: d.unidad,
                Placas: d.placas,
                Operador: d.operador,
                Ruta: d.ruta,
                Origen: d.origen,
                Destino: d.destino,
                Estatus: d.estatus,
                "Prog. Descarga": "",
                "Real Descarga": "",
                "ID Operador Monitoreo": "",
                "Estado GPS/Accesorios": "",
                "Fecha Validación GPS": "",
                "Total Incidencias": "",
                "Incidencia Tipo": inc.tipo,
                "Incidencia Severidad": inc.severidad,
                "Incidencia Fecha": formatDateTime(inc.fecha),
              });
            });
          }
        });

        const worksheet = XLSX.utils.json_to_sheet(rows);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "Informe Detallado");
        XLSX.writeFile(
          workbook,
          `Informe_Detallado_${dayjs().format("YYYY-MM-DD")}.xlsx`
        );
      }

      // --- Funciones para guardar y cargar informes de la BD ---

      function guardarInformeEnBD() {
        if (!lastInformeData || lastInformeData.length === 0) {
          alert("No hay datos de informe para guardar.");
          return;
        }

        // Calcular estadísticas
        const total = lastInformeData.length;
        const realizados = lastInformeData.filter(
          (d) => d.estatus === "Despacho realizado"
        );
        const aTiempo = realizados.filter(
          (d) =>
            d.realDescarga &&
            checkTimeDeviation(d.citaDescarga, d.realDescarga) ===
              "estatus-verde"
        ).length;
        const conRetraso = realizados.length - aTiempo;
        const enRuta = lastInformeData.filter(
          (d) => d.estatus === "En ruta"
        ).length;
        const programados = lastInformeData.filter(
          (d) => d.estatus === "Programado"
        ).length;
        const totalIncidencias = lastInformeData.reduce(
          (acc, d) => acc + d.incidencias.length,
          0
        );

        // Obtener ID del operador de monitoreo del primer despacho
        const operadorMonitoreo =
          lastInformeData[0]?.operadorMonitoreoId || "Desconocido";

        // Obtener fecha de despacho
        const fechaDespacho =
          document.getElementById("date-filter").value ||
          new Date().toISOString().split("T")[0];

        // Solicitar título para el informe
        const titulo = prompt(
          "Ingrese un título para el informe:",
          `Informe de Despachos - ${fechaDespacho} - Operador: ${operadorMonitoreo}`
        );

        if (!titulo) {
          alert("Debe ingresar un título para el informe.");
          return;
        }

        // Preparar datos del informe para guardar
        const datosInforme = {
          titulo: titulo,
          fecha_despacho: fechaDespacho,
          total_despachos: total,
          a_tiempo: aTiempo,
          con_retraso: conRetraso,
          en_ruta: enRuta,
          programados: programados,
          total_incidencias: totalIncidencias,
          operador_monitoreo: operadorMonitoreo,
          datos_detallados: lastInformeData,
          fecha_generacion: new Date().toISOString(),
        };

        // Mostrar loading
        const btnGuardar = document.getElementById("guardar-informe-btn");
        const originalText = btnGuardar.textContent;
        btnGuardar.textContent = "Guardando...";
        btnGuardar.disabled = true;

        // Enviar datos al servidor como JSON
        fetch("guardar_informe.php", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            titulo: titulo,
            fecha_despacho: fechaDespacho,
            total_despachos: total,
            a_tiempo: aTiempo,
            con_retraso: conRetraso,
            en_ruta: enRuta,
            programados: programados,
            total_incidencias: totalIncidencias,
            datos_informe: datosInforme,
            operador_monitoreo: operadorMonitoreo,
          }),
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
          })
          .then((data) => {
            if (data.success) {
              alert(`✅ Informe guardado correctamente con ID: ${data.id}`);
              // Recargar la lista de informes si estamos en esa pestaña
              if (
                document.querySelector(".tab-active").textContent.includes("07")
              ) {
                cargarInformesGuardados();
              }
            } else {
              alert(`❌ Error al guardar: ${data.message}`);
            }
          })
          .catch((error) => {
            alert(`❌ Error al conectar con el servidor: ${error.message}`);
          })
          .finally(() => {
            btnGuardar.textContent = originalText;
            btnGuardar.disabled = false;
          });
      }

      // --- Filtros (client-side) para Informes Guardados ---
      let informesGuardadosCache = [];

      function setInformesFilterSummary(visibleCount, totalCount) {
        const el = document.getElementById("informes-filtro-resumen");
        if (!el) return;
        const v = Number.isFinite(visibleCount) ? visibleCount : 0;
        const t = Number.isFinite(totalCount) ? totalCount : 0;
        el.textContent = `Mostrando ${v} de ${t}`;
      }

      function getNormalizedString(value) {
        return (value ?? "").toString().toLowerCase().trim();
      }

      function parseInformeDate(value) {
        const raw = (value ?? "").toString().trim();
        if (!raw) return null;
        const d = dayjs(raw, ["YYYY-MM-DD", "DD/MM/YYYY", "DD-MM-YYYY"], true);
        if (d.isValid()) return d.startOf("day");
        const iso = dayjs(raw);
        return iso.isValid() ? iso.startOf("day") : null;
      }

      function populateOperadorInformeFilter(informes) {
        const sel = document.getElementById("informes-filtro-operador");
        if (!sel) return;

        const current = sel.value || "";
        const unique = new Set();
        (informes || []).forEach((inf) => {
          const op = (inf?.operador_monitoreo ?? "").toString().trim();
          if (op) unique.add(op);
        });
        const operators = Array.from(unique).sort((a, b) =>
          a.localeCompare(b, "es", { sensitivity: "base" })
        );

        sel.innerHTML = "";
        const optAll = document.createElement("option");
        optAll.value = "";
        optAll.textContent = "Todos";
        sel.appendChild(optAll);
        operators.forEach((op) => {
          const opt = document.createElement("option");
          opt.value = op;
          opt.textContent = op;
          sel.appendChild(opt);
        });

        sel.value = operators.includes(current) ? current : "";
      }

      function applyInformesFilters() {
        const container = document.getElementById("informes-lista-container");
        if (!container) return;

        const all = Array.isArray(informesGuardadosCache)
          ? informesGuardadosCache
          : [];

        const q = getNormalizedString(
          document.getElementById("informes-filtro-texto")?.value
        );
        const operadorSel = (
          document.getElementById("informes-filtro-operador")?.value ?? ""
        )
          .toString()
          .trim();
        const soloIncidencias = Boolean(
          document.getElementById("informes-filtro-solo-incidencias")?.checked
        );
        const desde = parseInformeDate(
          document.getElementById("informes-filtro-fecha-desde")?.value
        );
        const hasta = parseInformeDate(
          document.getElementById("informes-filtro-fecha-hasta")?.value
        );

        const filtered = all.filter((inf) => {
          if (!inf) return false;

          if (q) {
            const haystack = [
              inf.id,
              inf.titulo,
              inf.operador_monitoreo,
              inf.fecha_despacho,
            ]
              .map(getNormalizedString)
              .join(" ");
            if (!haystack.includes(q)) return false;
          }

          if (operadorSel) {
            const op = (inf.operador_monitoreo ?? "").toString().trim();
            if (op !== operadorSel) return false;
          }

          if (soloIncidencias) {
            const ti = parseInt(inf.total_incidencias, 10) || 0;
            if (ti <= 0) return false;
          }

          if (desde || hasta) {
            const d = parseInformeDate(inf.fecha_despacho);
            if (!d) return false;
            if (desde && d.isBefore(desde)) return false;
            if (hasta && d.isAfter(hasta)) return false;
          }

          return true;
        });

        setInformesFilterSummary(filtered.length, all.length);
        mostrarInformes(filtered, container);
      }

      function resetInformesFilters() {
        const ids = [
          "informes-filtro-texto",
          "informes-filtro-fecha-desde",
          "informes-filtro-fecha-hasta",
        ];
        ids.forEach((id) => {
          const el = document.getElementById(id);
          if (el) el.value = "";
        });
        const op = document.getElementById("informes-filtro-operador");
        if (op) op.value = "";
        const chk = document.getElementById("informes-filtro-solo-incidencias");
        if (chk) chk.checked = false;
        applyInformesFilters();
      }

      function cargarInformesGuardados() {
        const container = document.getElementById("informes-lista-container");

        // Mostrar loading
        container.innerHTML = `
        <div class="text-center p-6">
            <p class="text-gray-500">Cargando informes guardados...</p>
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-blue-500 mt-2"></div>
        </div>
    `;

        // Fetch simple con manejo de errores mejorado
        fetch("obtener_informes.php")
          .then((response) => {
            if (!response.ok) {
              throw new Error(`Error HTTP ${response.status}`);
            }

            return response.text().then((text) => {
              // Verificar si la respuesta está completa
              if (!text.trim().endsWith("}")) {
                // Intentar completar el JSON si está truncado
                if (text.includes('{"success":')) {
                  const jsonStart = text.indexOf('{"success":');
                  if (jsonStart !== -1) {
                    // Extraer desde el inicio del JSON
                    let potentialJson = text.substring(jsonStart);

                    // Buscar el final del objeto
                    let braceCount = 0;
                    let inString = false;
                    let escapeNext = false;
                    let endIndex = -1;

                    for (let i = 0; i < potentialJson.length; i++) {
                      const char = potentialJson[i];

                      if (escapeNext) {
                        escapeNext = false;
                        continue;
                      }

                      if (char === "\\") {
                        escapeNext = true;
                        continue;
                      }

                      if (char === '"' && !escapeNext) {
                        inString = !inString;
                        continue;
                      }

                      if (!inString) {
                        if (char === "{") braceCount++;
                        if (char === "}") {
                          braceCount--;
                          if (braceCount === 0) {
                            endIndex = i + 1;
                            break;
                          }
                        }
                      }
                    }

                    if (endIndex !== -1) {
                      text = potentialJson.substring(0, endIndex);
                    }
                  }
                }
              }

              try {
                return JSON.parse(text);
              } catch (jsonError) {
                // Intentar extraer solo el array de datos si hay mucho output extra
                const match = text.match(/\{"success".*\}/s);
                if (match) {
                  try {
                    return JSON.parse(match[0]);
                  } catch (e) {
                    // Si falla, lanzar error original
                    throw new Error("JSON inválido del servidor");
                  }
                }

                throw jsonError;
              }
            });
          })
          .then((data) => {
            // Verificar estructura de respuesta
            if (data && data.success && Array.isArray(data.data)) {
              informesGuardadosCache = data.data;
              populateOperadorInformeFilter(informesGuardadosCache);
              applyInformesFilters();
            } else if (data && data.success && Array.isArray(data)) {
              // Compatibilidad con formato anterior
              informesGuardadosCache = data;
              populateOperadorInformeFilter(informesGuardadosCache);
              applyInformesFilters();
            } else if (data && data.message) {
              // Mostrar mensaje del servidor
              container.innerHTML = `
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6">
                        <div class="flex items-center mb-3">
                            <svg class="w-6 h-6 text-yellow-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            <h3 class="text-lg font-semibold text-yellow-700">Información</h3>
                        </div>
                        <p class="text-yellow-600">${data.message}</p>
                        <p class="text-yellow-500 text-sm mt-2">No hay informes guardados todavía.</p>
                    </div>
                `;
              informesGuardadosCache = [];
              setInformesFilterSummary(0, 0);
            } else {
              throw new Error(
                data?.message || "Estructura de datos inesperada"
              );
            }
          })
          .catch((error) => {
            // Mostrar error con opciones de recuperación
            container.innerHTML = `
                <div class="bg-red-50 border border-red-200 rounded-lg p-6">
                    <div class="flex items-center mb-3">
                        <svg class="w-6 h-6 text-red-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <h3 class="text-lg font-semibold text-red-700">Error al cargar informes</h3>
                    </div>
                    <p class="text-red-600">${error.message}</p>
                    <div class="mt-4 space-x-2">
                        <button onclick="cargarInformesGuardados()" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">
                            Reintentar
                        </button>
                        <button onclick="probarServidor()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                            Probar Servidor
                        </button>
                        <button onclick="mostrarDatosLocales()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
                            Datos Locales
                        </button>
                    </div>
                </div>
            `;
          });
      }

      // Función para probar el servidor
      function probarServidor() {
        fetch("obtener_informes.php")
          .then((r) => r.text())
          .then((text) => {
            alert(
              "Respuesta del servidor (primeros 1000 chars):\n\n" +
                text.substring(0, 1000)
            );
          })
          .catch((error) => {
            alert("Error: " + error.message);
          });
      }

      // Función para mostrar datos locales (fallback)
      function mostrarDatosLocales() {
        try {
          const datosGuardados = localStorage.getItem("informes_guardados");
          if (datosGuardados) {
            const informes = JSON.parse(datosGuardados);
            const container = document.getElementById(
              "informes-lista-container"
            );
            mostrarInformes(informes, container);

            // Mostrar aviso
            const aviso = document.createElement("div");
            aviso.className =
              "bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4";
            aviso.innerHTML = `
                <p class="text-yellow-700 font-semibold">⚠️ Modo offline</p>
                <p class="text-yellow-600 text-sm">Mostrando datos guardados localmente. Es posible que no estén actualizados.</p>
            `;
            container.prepend(aviso);
          } else {
            alert("No hay datos guardados localmente.");
          }
        } catch (e) {
          alert("Error al cargar datos locales.");
        }
      }

      // Función para probar conexión
      function testConexionInformes() {
        fetch("obtener_informes.php")
          .then((response) => response.text())
          .then((text) => {
            alert("Respuesta del servidor:\n\n" + text.substring(0, 500));
          })
          .catch((error) => {
            alert("Error: " + error.message);
          });
      }

      // Función simplificada para mostrar informes
      function mostrarInformes(informes, container) {
        if (!informes || informes.length === 0) {
          const total = Array.isArray(informesGuardadosCache)
            ? informesGuardadosCache.length
            : 0;
          setInformesFilterSummary(0, total);
          container.innerHTML = `
            <div class="text-center p-10 bg-gray-50 rounded-lg">
                <svg class="w-16 h-16 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                </svg>
                <h3 class="text-lg font-medium text-gray-700">No hay informes guardados</h3>
                <p class="text-gray-500 mt-2">Los informes que guardes aparecerán aquí.</p>
                <p class="text-gray-400 text-sm mt-1">Ve a la pestaña "06. Informe Ejecutivo" para crear uno.</p>
            </div>
        `;
          return;
        }

        try {
          const total = Array.isArray(informesGuardadosCache)
            ? informesGuardadosCache.length
            : informes.length;
          setInformesFilterSummary(informes.length, total);
        } catch (e) {}

        // Ordenar por fecha más reciente primero
        informes.sort((a, b) => {
          const dateA = new Date(a.fecha_creacion || 0);
          const dateB = new Date(b.fecha_creacion || 0);
          return dateB - dateA;
        });

        let html = `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">`;

        informes.forEach((informe) => {
          // Validar y limpiar datos
          const id = parseInt(informe.id) || 0;
          const titulo = informe.titulo?.toString() || "Sin título";
          const fechaDespacho =
            informe.fecha_despacho?.toString() || "No especificada";
          const operador =
            informe.operador_monitoreo?.toString() || "No especificado";

          // Formatear fecha de creación
          let fechaFormateada = "Fecha no disponible";
          try {
            if (informe.fecha_creacion) {
              const fecha = new Date(informe.fecha_creacion);
              if (!isNaN(fecha.getTime())) {
                fechaFormateada = fecha.toLocaleDateString("es-MX", {
                  year: "numeric",
                  month: "long",
                  day: "numeric",
                  hour: "2-digit",
                  minute: "2-digit",
                });
              }
            }
          } catch (e) {
            console.warn("Error formateando fecha:", e);
          }

          // Convertir números
          const totalDespachos = parseInt(informe.total_despachos) || 0;
          const aTiempo = parseInt(informe.a_tiempo) || 0;
          const conRetraso = parseInt(informe.con_retraso) || 0;
          const enRuta = parseInt(informe.en_ruta) || 0;
          const programados = parseInt(informe.programados) || 0;
          const totalIncidencias = parseInt(informe.total_incidencias) || 0;

          html += `
            <div class="bg-white rounded-xl shadow-md border border-gray-200 overflow-hidden hover:shadow-lg transition-shadow duration-300">
                <div class="p-5">
                    <!-- Encabezado -->
                    <div class="flex justify-between items-start mb-3">
                        <h3 class="font-bold text-lg text-blue-800 truncate" title="${titulo}">
                            ${titulo}
                        </h3>
                        <span class="bg-blue-100 text-blue-800 text-xs font-semibold px-2.5 py-0.5 rounded-full whitespace-nowrap">
                            ID: ${id}
                        </span>
                    </div>
                    
                    <!-- Fecha -->
                    <div class="flex items-center text-sm text-gray-500 mb-4">
                        <svg class="w-4 h-4 mr-1 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                        </svg>
                        <span class="truncate">${fechaFormateada}</span>
                    </div>
                    
                    <!-- Estadísticas -->
                    <div class="grid grid-cols-2 gap-3 mb-4">
                        <div class="bg-gray-50 p-3 rounded-lg">
                            <p class="text-xs text-gray-500">Total Despachos</p>
                            <p class="text-lg font-bold">${totalDespachos}</p>
                        </div>
                        <div class="bg-green-50 p-3 rounded-lg">
                            <p class="text-xs text-gray-500">A Tiempo</p>
                            <p class="text-lg font-bold text-green-600">${aTiempo}</p>
                        </div>
                        <div class="bg-red-50 p-3 rounded-lg">
                            <p class="text-xs text-gray-500">Con Retraso</p>
                            <p class="text-lg font-bold text-red-600">${conRetraso}</p>
                        </div>
                        <div class="bg-yellow-50 p-3 rounded-lg">
                            <p class="text-xs text-gray-500">Incidencias</p>
                            <p class="text-lg font-bold text-yellow-600">${totalIncidencias}</p>
                        </div>
                    </div>
                    
                    <!-- Información adicional -->
                    <div class="text-sm text-gray-600 mb-4 space-y-1">
                        <p class="truncate"><strong class="text-gray-700">Operador:</strong> ${operador}</p>
                        <p><strong class="text-gray-700">Fecha Despacho:</strong> ${fechaDespacho}</p>
                    </div>
                    
                    <!-- Botones -->
                    <div class="flex space-x-2">
                        <button onclick="verInformeDetalle(${id})" 
                                class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 text-sm font-medium transition-colors duration-200">
                            Ver Detalle
                        </button>
                        <button onclick="eliminarInforme(${id})" 
                                class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 text-sm font-medium transition-colors duration-200"
                                title="Eliminar informe">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        `;
        });

        html += `</div>`;
        container.innerHTML = html;

        // Guardar localmente para uso offline
        try {
          localStorage.setItem("informes_guardados", JSON.stringify(informes));
        } catch (e) {
          console.warn("No se pudieron guardar datos localmente:", e);
        }
      }

      // Función simplificada para ver detalle
      function verInformeDetalle(id) {
        if (!id || id <= 0) {
          alert(
            "Este es un informe de ejemplo. Para ver detalles reales, guarda un informe primero."
          );
          return;
        }

        fetch(`obtener_informe_detalle.php?id=${id}`)
          .then((response) => response.text())
          .then((text) => {
            try {
              const data = JSON.parse(text);
              mostrarModalInforme(data);
            } catch (error) {
              alert(
                "Error al cargar el detalle del informe. Verifica la consola para más información."
              );
            }
          })
          .catch((error) => {
            alert(
              "No se pudo cargar el detalle del informe. Error: " +
                error.message
            );
          });
      }

      function mostrarModalInforme(informe) {
        const FIELD_LABELS = {
          folio: "Folio",
          fechaProgramada: "Fecha programada",
          unidad: "Unidad",
          placas: "Placas",
          operador: "Operador",
          telefono: "Teléfono",
          ruta: "Ruta",
          origen: "Origen",
          destino: "Destino",
          citaSalidaUnidad: "Cita salida de unidad",
          citaCarga: "Cita de carga",
          citaSalida: "Cita salida de carga",
          citaDescarga: "Cita de descarga",
          realSalidaUnidad: "Real salida de unidad",
          realCarga: "Real cita de carga",
          realSalida: "Real salida de carga",
          realDescarga: "Real cita de descarga",
          realConfirmacionEntrega: "Real confirmación de entrega",
          confirmacionEntrega: "Confirmación de entrega",
          estatus: "Estatus",
          incidencias: "Incidencias",
          observaciones: "Observaciones",
          observacionesTimestamp: "Fecha observaciones",
          operadorMonitoreoId: "ID operador monitoreo",
          gpsValidacionEstado: "Estado GPS/Accesorios",
          gpsValidacionTimestamp: "Fecha validación GPS",
        };

        function escapeHtml(value) {
          return String(value)
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/\"/g, "&quot;")
            .replace(/'/g, "&#39;");
        }

        function formatFechaAmigable(value) {
          if (value === null || value === undefined) return "";
          if (typeof value !== "string") return String(value);
          const trimmed = value.trim();
          if (!trimmed) return "";

          // Fecha simple YYYY-MM-DD
          if (/^\d{4}-\d{2}-\d{2}$/.test(trimmed)) {
            const d = dayjs(trimmed);
            return d.isValid() ? d.format("DD/MM/YYYY") : trimmed;
          }

          // ISO datetime
          const d = dayjs(trimmed);
          return d.isValid() && trimmed.includes("T")
            ? formatDateTime(trimmed)
            : trimmed;
        }

        function renderValue(key, value) {
          if (value === null || value === undefined || value === "") {
            return '<span class="text-gray-400">—</span>';
          }

          if (key === "incidencias") {
            if (!Array.isArray(value) || value.length === 0) {
              return '<span class="text-gray-500">Sin incidencias</span>';
            }

            return `
              <div class="space-y-2">
                ${value
                  .map((inc) => {
                    const sev = (inc?.severidad || "").toString().toLowerCase();
                    const sevClass = sev
                      ? `incidencia-${escapeHtml(sev)}`
                      : "bg-gray-50 text-gray-700 border-l-4 border-gray-300";
                    const tipo = escapeHtml(inc?.tipo || "Incidencia");
                    const fecha = escapeHtml(
                      formatFechaAmigable(inc?.fecha || "")
                    );
                    return `
                      <div class="text-sm p-2 rounded-md ${sevClass}">
                        <div class="font-semibold">${tipo}</div>
                        <div class="text-xs opacity-80">${fecha || "—"}</div>
                      </div>
                    `;
                  })
                  .join("")}
              </div>
            `;
          }

          if (typeof value === "boolean")
            return escapeHtml(value ? "Sí" : "No");
          if (typeof value === "number") return escapeHtml(value);

          // Fechas/horas
          const lowerKey = String(key).toLowerCase();
          const looksLikeDate =
            lowerKey.includes("fecha") ||
            lowerKey.includes("cita") ||
            lowerKey.includes("timestamp") ||
            lowerKey.startsWith("real");
          if (typeof value === "string" && looksLikeDate) {
            const formatted = formatFechaAmigable(value);
            return formatted
              ? escapeHtml(formatted)
              : '<span class="text-gray-400">—</span>';
          }

          return escapeHtml(value);
        }

        function renderCardViaje(viaje) {
          function labelForKey(key) {
            if (FIELD_LABELS[key]) return FIELD_LABELS[key];
            // Fallback: separar camelCase / snake_case y capitalizar
            return String(key)
              .replace(/_/g, " ")
              .replace(/([a-z])([A-Z])/g, "$1 $2")
              .replace(/^\w/, (c) => c.toUpperCase());
          }

          const estatus = (viaje?.estatus || "").toString();
          let badgeClass = "bg-gray-100 text-gray-700";
          if (estatus === "En ruta")
            badgeClass = "bg-yellow-100 text-yellow-800";
          else if (estatus === "Despacho realizado")
            badgeClass = "bg-green-100 text-green-800";
          else if (estatus === "Despacho No realizado")
            badgeClass = "bg-red-100 text-red-800";

          const ordenPreferida = [
            "folio",
            "fechaProgramada",
            "unidad",
            "placas",
            "operador",
            "telefono",
            "ruta",
            "origen",
            "destino",
            "citaSalidaUnidad",
            "citaCarga",
            "citaSalida",
            "citaDescarga",
            "realSalidaUnidad",
            "realCarga",
            "realSalida",
            "realDescarga",
            "realConfirmacionEntrega",
            "confirmacionEntrega",
            "estatus",
            "observaciones",
            "observacionesTimestamp",
            "operadorMonitoreoId",
            "gpsValidacionEstado",
            "gpsValidacionTimestamp",
          ];

          const keys = Object.keys(viaje || {});
          const orderedKeys = [
            ...ordenPreferida.filter((k) => keys.includes(k)),
            ...keys.filter((k) => !ordenPreferida.includes(k)),
          ];

          const rows = orderedKeys
            .filter((k) => k !== "incidencias")
            .map((k) => {
              const label = escapeHtml(labelForKey(k));
              const val = renderValue(k, viaje[k]);
              return `
                <div>
                  <dt class="text-xs text-gray-500">${label}</dt>
                  <dd class="text-sm font-medium text-gray-900 break-words">${val}</dd>
                </div>
              `;
            })
            .join("");

          const incidenciasHtml = `
            <div class="mt-4">
              <h6 class="text-sm font-semibold text-gray-800 mb-2">Incidencias</h6>
              ${renderValue("incidencias", (viaje && viaje.incidencias) || [])}
            </div>
          `;

          return `
            <div class="bg-white border border-gray-200 rounded-xl p-4 shadow-sm">
              <div class="flex items-start justify-between gap-3 mb-3">
                <div class="min-w-0">
                  <div class="font-bold text-gray-900 truncate">
                    ${escapeHtml(viaje?.unidad || "Sin unidad")}
                    <span class="text-gray-400 font-normal">·</span>
                    <span class="text-gray-600 font-semibold">Folio ${escapeHtml(
                      viaje?.folio ?? "—"
                    )}</span>
                  </div>
                  <div class="text-xs text-gray-500 truncate">
                    ${escapeHtml(viaje?.ruta || "")}
                  </div>
                </div>
                <span class="text-xs font-semibold px-2.5 py-1 rounded-full ${badgeClass} whitespace-nowrap">
                  ${escapeHtml(estatus || "Sin estatus")}
                </span>
              </div>

              <dl class="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-3">
                ${rows}
              </dl>

              ${incidenciasHtml}
            </div>
          `;
        }

        // Título
        document.getElementById("modal-informe-titulo").textContent =
          informe.titulo || "Sin título";

        // Formatear fecha
        let fechaCreacion = "No disponible";
        try {
          const fechaObj = new Date(informe.fecha_creacion);
          if (!isNaN(fechaObj.getTime())) {
            fechaCreacion = fechaObj.toLocaleString("es-MX", {
              year: "numeric",
              month: "long",
              day: "numeric",
              hour: "2-digit",
              minute: "2-digit",
            });
          }
        } catch (e) {
          console.warn("Error formateando fecha:", e);
        }

        let html = `
        <div class="space-y-6">
            <!-- Estadísticas principales -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="bg-gray-100 p-4 rounded-lg text-center">
                    <p class="text-sm font-medium text-gray-600">Total Despachos</p>
                    <p class="text-2xl font-bold mt-1">${informe.total_despachos || 0}</p>
                </div>
                <div class="bg-green-100 p-4 rounded-lg text-center">
                    <p class="text-sm font-medium text-green-700">A Tiempo</p>
                    <p class="text-2xl font-bold text-green-800 mt-1">${informe.a_tiempo || 0}</p>
                </div>
                <div class="bg-red-100 p-4 rounded-lg text-center">
                    <p class="text-sm font-medium text-red-700">Con Retraso</p>
                    <p class="text-2xl font-bold text-red-800 mt-1">${informe.con_retraso || 0}</p>
                </div>
                <div class="bg-yellow-100 p-4 rounded-lg text-center">
                    <p class="text-sm font-medium text-yellow-700">Incidencias</p>
                    <p class="text-2xl font-bold text-yellow-800 mt-1">${informe.total_incidencias || 0}</p>
                </div>
            </div>
            
            <!-- Información general -->
            <div class="bg-blue-50 border border-blue-100 rounded-lg p-4">
                <h4 class="font-semibold text-blue-800 mb-2">Información General</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm">
                    <p><span class="font-medium text-gray-700">Fecha de creación:</span> ${fechaCreacion}</p>
                    <p><span class="font-medium text-gray-700">Fecha de despacho:</span> ${informe.fecha_despacho || "No especificada"}</p>
                    <p><span class="font-medium text-gray-700">Operador:</span> ${informe.operador_monitoreo || "No especificado"}</p>
                    <p><span class="font-medium text-gray-700">ID del informe:</span> ${informe.id || "N/A"}</p>
                </div>
            </div>
    `;

        // Mostrar datos detallados si existen
        if (informe.datos_informe_decoded) {
          const detalles = informe.datos_informe_decoded;

          html += `
            <div>
                <h4 class="font-semibold text-gray-800 mb-3">Detalles del Informe</h4>
                
                <!-- Resumen -->
                <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-4">
                    <h5 class="font-medium text-gray-700 mb-2">Resumen:</h5>
                    <p class="text-sm text-gray-600">${detalles.titulo || "Sin título específico"}</p>
                    <div class="grid grid-cols-2 gap-2 mt-3">
                        <p class="text-sm"><span class="font-medium">Fecha generación:</span> ${detalles.fecha_generacion ? new Date(detalles.fecha_generacion).toLocaleString("es-MX") : "N/A"}</p>
                        <p class="text-sm"><span class="font-medium">Total registros:</span> ${detalles.datos_detallados ? detalles.datos_detallados.length : 0}</p>
                    </div>
                </div>

                <!-- Viajes en formato Card -->
                <div class="mt-4">
                  <h5 class="font-medium text-gray-700 mb-3">Viajes</h5>
                  <div class="max-h-96 overflow-y-auto pr-1">
                  <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                    ${
                      Array.isArray(detalles.datos_detallados)
                        ? detalles.datos_detallados
                            .map((v) => renderCardViaje(v))
                            .join("")
                        : renderCardViaje(detalles.datos_detallados || {})
                    }
                  </div>
                  </div>
                </div>
            </div>
            
        `;
        } else if (informe.datos_informe) {
          html += `
            <div>
                <h4 class="font-semibold text-gray-800 mb-3">Datos del Informe</h4>
                <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 max-h-60 overflow-y-auto">
                  <p class="text-sm text-gray-700 whitespace-pre-wrap">${escapeHtml(informe.datos_informe.substring(0, 1000))}${informe.datos_informe.length > 1000 ? "..." : ""}</p>
                </div>
            </div>
        `;
        }

        html += `</div>`;

        document.getElementById("modal-informe-body").innerHTML = html;
      }

      function toggleDetalleCompleto() {
        const detalle = document.getElementById("detalle-completo");
        const icon = document.getElementById("detalle-icon");

        // Compatibilidad: si ya no existe el bloque colapsable, no hacer nada.
        if (!detalle || !icon) return;

        if (detalle.classList.contains("hidden")) {
          detalle.classList.remove("hidden");
          icon.classList.add("rotate-90");
        } else {
          detalle.classList.add("hidden");
          icon.classList.remove("rotate-90");
        }
      }

      function verInformeDetalle(id) {
        if (!id || id <= 0) {
          alert("ID de informe inválido");
          return;
        }

        // Mostrar loading en el modal
        document.getElementById("modal-informe-body").innerHTML = `
          <div class="text-center p-6">
              <div class="inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-blue-500"></div>
              <p class="mt-2 text-gray-500">Cargando detalles...</p>
          </div>
      `;

        document.getElementById("modal-informe-titulo").textContent =
          "Cargando...";
        openModal("modal-informe-detalle");

        // Cargar detalles con la nueva estructura
        fetch(`obtener_informe_detalle.php?id=${id}`)
          .then((response) => {
            if (!response.ok) {
              throw new Error(`HTTP ${response.status}`);
            }

            return response.json();
          })
          .then((data) => {
            if (data.success && data.data) {
              mostrarModalInforme(data.data);
            } else {
              throw new Error(data.message || "Informe no encontrado");
            }
          })
          .catch((error) => {
            document.getElementById("modal-informe-body").innerHTML = `
                  <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                      <p class="text-red-700 font-semibold">Error al cargar el informe</p>
                      <p class="text-red-600 text-sm mt-1">${error.message}</p>
                      <div class="mt-3 space-x-2">
                          <button onclick="verInformeDetalle(${id})" class="bg-red-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-red-700">
                              Reintentar
                          </button>
                          <button onclick="closeModal('modal-informe-detalle')" class="bg-gray-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-gray-700">
                              Cerrar
                          </button>
                      </div>
                  </div>
              `;
          });
      }
      function eliminarInforme(id) {
        if (
          !confirm(
            "¿Está seguro de que desea eliminar este informe? Esta acción no se puede deshacer."
          )
        ) {
          return;
        }

        fetch("eliminar_informe.php", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ id: id }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              alert("✅ Informe eliminado correctamente");
              cargarInformesGuardados(); // Recargar lista
            } else {
              alert(`❌ Error: ${data.message}`);
            }
          })
          .catch((error) => {
            alert("❌ Error al eliminar el informe");
          });
      }

      //   function descargarInformeModal() {
      //     const titulo = document.getElementById(
      //       "modal-informe-titulo"
      //     ).textContent;
      //     const contenido =
      //       document.getElementById("modal-informe-body").innerHTML;

      //     const blob = new Blob(
      //       [
      //         `
      //     <html>
      //         <head>
      //             <meta charset="UTF-8">
      //             <title>${titulo}</title>
      //             <style>
      //                 body { font-family: Arial, sans-serif; margin: 20px; }
      //                 table { border-collapse: collapse; width: 100%; }
      //                 th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
      //                 th { background-color: #f2f2f2; }
      //             </style>
      //         </head>
      //         <body>
      //             <h1>${titulo}</h1>
      //             ${contenido}
      //         </body>
      //     </html>
      // `,
      //       ],
      //       { type: "text/html" }
      //     );

      //     const url = URL.createObjectURL(blob);
      //     const link = document.createElement("a");
      //     link.href = url;
      //     link.download = `${titulo.replace(/[^a-z0-9]/gi, "_")}.html`;
      //     document.body.appendChild(link);
      //     link.click();
      //     document.body.removeChild(link);
      //     URL.revokeObjectURL(url);
      //   }

      // function exportarTodosInformes() {
      //   fetch("obtener_informes.php")
      //     .then((response) => response.json())
      //     .then((informes) => {
      //       if (!informes || informes.length === 0) {
      //         alert("No hay informes para exportar");
      //         return;
      //       }

      //       // Convertir a CSV
      //       let csv =
      //         "ID,Título,Fecha Creación,Fecha Despacho,Total Despachos,A Tiempo,Con Retraso,En Ruta,Programados,Total Incidencias,Operador\n";

      //       informes.forEach((informe) => {
      //         csv += `"${informe.id || ""}","${(informe.titulo || "").replace(/"/g, '""')}","${informe.fecha_creacion || ""}","${informe.fecha_despacho || ""}","${informe.total_despachos || 0}","${informe.a_tiempo || 0}","${informe.con_retraso || 0}","${informe.en_ruta || 0}","${informe.programados || 0}","${informe.total_incidencias || 0}","${informe.operador_monitoreo || ""}"\n`;
      //       });

      //       // Crear y descargar archivo
      //       const blob = new Blob(["\uFEFF" + csv], {
      //         type: "text/csv;charset=utf-8;",
      //       });
      //       const url = URL.createObjectURL(blob);
      //       const link = document.createElement("a");
      //       link.href = url;
      //       link.download = `informes_${new Date().toISOString().split("T")[0]}.csv`;
      //       document.body.appendChild(link);
      //       link.click();
      //       document.body.removeChild(link);
      //       URL.revokeObjectURL(url);
      //     })
      //     .catch((error) => {
      //       alert("Error al exportar informes: " + error.message);
      //     });
      // }

      // Modificar la función changeTab para cargar informes cuando se seleccione la pestaña 7
      function changeTab(index) {
        document.querySelectorAll(".tab-btn").forEach((tab, i) => {
          const content = document.getElementById(`tab-${i}`);
          tab.classList.toggle("tab-active", i === index);
          tab.classList.toggle("text-gray-500", i !== index);
          if (content) content.classList.toggle("hidden", i !== index);
        });

        if (index === 4) filterAndRenderKPIs("selectedDate");
        if (index === 5) filterAndRenderInforme("selectedDate");
        if (index === 6) {
          cargarInformesGuardados();
        }
      }
    </script>
  </body>
</html>
